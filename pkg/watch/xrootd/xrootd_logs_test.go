package xrootd

import (
	"bytes"
	"regexp"
	"testing"

	"github.com/msoap/byline"
)

func TestGrepReader(t *testing.T) {
	reader := bytes.NewBufferString(`{"level":"info","ts":1596115683.4264386,"logger":"XrootdLogsWatcher","msg":"logging all","pod":"base-xrootd-xrootd-worker-0","component":"xrootd-worker","orig":"string(orig)","newg":"+ service=\n+ getopts hs: c\n+ case $c in\n+ service=cmsd\n+ getopts hs: c\n+ '[' 2 -eq 0 ']'\n+ '[' -z cmsd ']'\n+ printf '%s\\n' cmsd\n+ egrep -qv '^(xrootd|cmsd)$'\n+ shift 2\n+ CONFIG_DIR=/config-etc\n+ XROOTD_CONFIG=/config-etc/xrootd.cf\n+ XROOTD_RDR_DN=base-xrootd-xrootd-redirector\n+ hostname\n+ egrep '^base-xrootd-xrootd-redirector-[0-9]+$'\n+ COMPONENT_NAME=worker\n+ export COMPONENT_NAME\n++ whoami\n+ echo 'Start cmsd as xrootd user'\n+ cmd='cmsd -c /config-etc/xrootd.cf -n worker'\n+ exec cmsd -c /config-etc/xrootd.cf -n worker\nStart cmsd as xrootd user\n200730 13:27:24 001 Starting on Linux 5.7.10-arch1-1\nCopr.  2004-2012 Stanford University, xrd version v4.11.2\nConfig warning: this hostname, base-xrootd-xrootd-worker-0, is registered without a domain qualification.\n++++++ cmsd worker@base-xrootd-xrootd-worker-0 initialization started.\nConfig using configuration file /config-etc/xrootd.cf\n=====> xrd.sched mint 32 maxt 8192 avlt 512 idle 780\n=====> xrd.network buffsz 0 nodnr\n=====> all.adminpath /tmp/xrd\n=====> xrd.timeout idle 48h\n=====> xrd.network dyndns\n=====> xrd.network cache 0\n=====> xrd.port 1094\n=====> xrd.port 2131\nConfig maximum number of connections restricted to 1048576\nCopr.  2007 Stanford University/SLAC cmsd.\n++++++ worker@base-xrootd-xrootd-worker-0 phase 1 initialization started.\n=====> all.role server\n=====> cms.space 1k 2k\n=====> cms.sched cpu 10 io 10 space 80\n=====> oss.defaults nomig nodread stage nocheck norcreate\n=====> all.export /data r/w nocheck norcreate\n=====> all.adminpath /tmp/xrd\n=====> all.manager base-xrootd-xrootd-redirector:2131\nThe following paths are available to the redirector:\nws /data\n \n------ worker@base-xrootd-xrootd-worker-0 phase 1 server initialization completed.\n++++++ worker@base-xrootd-xrootd-worker-0 phase 2 server initialization started.\nConfig warning: adminpath resides in /tmp and may be unstable!\n++++++ Storage system initialization started.\n=====> oss.defaults nomig nodread stage nocheck norcreate\n=====> oss.alloc 512M 2 0\n=====> oss.fdlimit * max\n=====> all.export /data r/w nocheck norcreate\n++++++ Configuring standalone mode . . .\nConfig effective /config-etc/xrootd.cf oss configuration:\n       oss.alloc        536870912 2 0\n       oss.cachescan    600\n       oss.fdlimit      524288 1048576\n       oss.maxsize      0\n       oss.trace        0\n       oss.xfr          1 deny 10800 keep 1200\n       oss.memfile off  max 8230289408\n       oss.defaults  r/w  nocheck nodread nomig norcreate nopurge stage xattr\n       oss.path /data r/w  nocheck nodread nomig norcreate nopurge stage xattr\n------ Storage system initialization completed.\n200730 13:27:24 001 Meter: Found 1 filesystem(s); 107GB total (79% util); 23GB free (23GB max)\n------ worker@base-xrootd-xrootd-worker-0 phase 2 server initialization completed.\n200730 13:27:24 034 Start: Waiting for primary server to login.\n------ cmsd worker@base-xrootd-xrootd-worker-0:36873 initialization completed.\n200730 13:27:24 036 do_Login:: Primary server 1 logged in; data port is 1094\nConfig Connecting to 1 manager and 1 site.\n200730 13:27:24 021 Config: server service enabled.\n200730 13:27:24 037 State: Status changed to active + staging\n200730 13:27:24 018 XrdOpen: Unable to create socket for 'base-xrootd-xrootd-redirector'; dynamic name or service not yet registered\n200730 13:27:54 018 ManTree: Now connected to 1 root node(s)\n200730 13:27:54 018 Protocol: Logged into 192.168.82.8\n"}`)
	// reader := bytes.NewBufferString(`{"level":"info","ts":1596117898.0653794,"logger":"XrootdLogsWatcher","msg":"logging all","pod":"base-xrootd-xrootd-redirector-0","component":"xrootd-redirector","orig":"string(orig)","newg":"+ service=\n+ getopts hs: c\n+ case $c in\n+ service=cmsd\n+ getopts hs: c\n+ '[' 2 -eq 0 ']'\n+ '[' -z cmsd ']'\n+ printf '%s\\n' cmsd\n+ egrep -qv '^(xrootd|cmsd)$'\n+ shift 2\n+ CONFIG_DIR=/config-etc\n+ XROOTD_CONFIG=/config-etc/xrootd.cf\n+ XROOTD_RDR_DN=base-xrootd-xrootd-redirector\n+ hostname\n+ egrep '^base-xrootd-xrootd-redirector-[0-9]+$'\nbase-xrootd-xrootd-redirector-0\n+ COMPONENT_NAME=manager\n+ export COMPONENT_NAME\n++ whoami\nStart cmsd as xrootd user\n+ echo 'Start cmsd as xrootd user'\n+ cmd='cmsd -c /config-etc/xrootd.cf -n manager'\n+ exec cmsd -c /config-etc/xrootd.cf -n manager\n200730 14:03:13 001 Starting on Linux 5.7.10-arch1-1\nCopr.  2004-2012 Stanford University, xrd version v4.11.2\nConfig warning: this hostname, base-xrootd-xrootd-redirector-0, is registered without a domain qualification.\n++++++ cmsd manager@base-xrootd-xrootd-redirector-0 initialization started.\nConfig using configuration file /config-etc/xrootd.cf\n=====> all.adminpath /tmp/xrd\n=====> xrd.timeout idle 48h\n=====> xrd.network dyndns\n=====> xrd.network cache 0\n=====> xrd.port 1094\n=====> xrd.port 2131\nConfig maximum number of connections restricted to 1048576\nCopr.  2007 Stanford University/SLAC cmsd.\n++++++ manager@base-xrootd-xrootd-redirector-0 phase 1 initialization started.\n=====> all.role manager\n=====> cms.delay servers 1 startup 10 lookup 1 qdl 1\n=====> cms.sched cpu 10 io 10 space 80\n=====> all.export /data r/w nocheck norcreate\n=====> all.adminpath /tmp/xrd\n=====> all.manager base-xrootd-xrootd-redirector:2131\n------ manager@base-xrootd-xrootd-redirector-0 phase 1 manager initialization completed.\n++++++ manager@base-xrootd-xrootd-redirector-0 phase 2 manager initialization started.\nConfig warning: adminpath resides in /tmp and may be unstable!\n++++++ Storage system initialization started.\n=====> all.export /data r/w nocheck norcreate\n++++++ Configuring standalone mode . . .\nConfig effective /config-etc/xrootd.cf oss configuration:\n       oss.alloc        0 0 0\n       oss.cachescan    600\n       oss.fdlimit      524288 1048576\n       oss.maxsize      0\n       oss.trace        0\n       oss.xfr          1 deny 10800 keep 1200\n       oss.memfile off  max 8230289408\n       oss.defaults  r/w  nocheck nodread nomig norcreate nopurge nostage xattr\n       oss.path /data r/w  nocheck nodread nomig norcreate nopurge nostage xattr\n------ Storage system initialization completed.\n------ manager@base-xrootd-xrootd-redirector-0 phase 2 manager initialization completed.\n------ cmsd manager@base-xrootd-xrootd-redirector-0:2131 initialization completed.\n200730 14:03:20 016 Protocol: redirector.1:19@base-xrootd-xrootd-redirector-0 logged in.\n200730 14:03:23 015 Config: manager service enabled.\n200730 14:03:23 030 State: Status changed to suspended + nostaging\n200730 14:03:24 030 State: Status changed to active + staging\n200730 14:03:24 031 Protocol: Primary server.1:20@192-168-82-46.base-xrootd-xrootd-worker.default.svc.cluster.local:1094 logged in.\n200730 14:03:24 031 Protocol: server.1:20@192-168-82-46.base-xrootd-xrootd-worker.default.svc.cluster.local:1094 system ID: s-worker@base-xrootd-xrootd-worker-0 2131base-xrootd-xrootd-redirector\n=====> Routing for 192.168.82.46: local pub4 prv4 \n=====> Route all4: 192.168.82.46 Dest=[::192.168.82.46]:1094\n"}`)
	regex := regexp.MustCompile(`Protocol: Logged into .+$`)
	// regex := regexp.MustCompile(`Protocol: redirector..+ logged in.`)
	lineReader := byline.NewReader(reader)
	buffer := make([]byte, 50)
	t.Log("Reading...", "regex", regex, "buffer", buffer)
	read, err := lineReader.GrepByRegexp(regex).Read(buffer)
	if err != nil {
		t.Error(err, "failed to read")
	}

	t.Logf("read: %d, buffer: %s", read, string(buffer))
	t.Error("error")
}
